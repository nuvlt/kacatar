<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîê Admin Panel - Logo Y√∂netimi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .logo-missing { border: 3px solid #ef4444; }
    .logo-ok { border: 3px solid #10b981; }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold">üîê Admin Panel</h1>
        <p class="text-sm text-blue-100">Logo Y√∂netimi & G√ºncelleme</p>
      </div>
      <div class="text-right">
        <div class="text-sm">Toplam Ma√ß: <span id="totalMatches" class="font-bold">-</span></div>
        <div class="text-sm">Eksik Logo: <span id="missingCount" class="font-bold text-red-300">-</span></div>
      </div>
    </div>
  </header>

  <!-- Filter Bar -->
  <div class="max-w-7xl mx-auto px-6 py-4">
    <div class="bg-white rounded-lg shadow p-4 flex gap-4 items-center">
      <div class="flex-1">
        <input 
          type="text" 
          id="searchInput" 
          placeholder="üîç Takƒ±m adƒ± ara..." 
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
      </div>
      <div class="flex gap-2">
        <button onclick="filterMatches('all')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">
          T√ºm√º
        </button>
        <button onclick="filterMatches('missing')" class="filter-btn px-4 py-2 rounded-lg bg-red-100 text-red-700 hover:bg-red-200">
          Eksikler
        </button>
        <button onclick="filterMatches('complete')" class="filter-btn px-4 py-2 rounded-lg bg-green-100 text-green-700 hover:bg-green-200">
          Tamamlar
        </button>
      </div>
      <button onclick="loadMatches()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
        üîÑ Yenile
      </button>
    </div>
  </div>

  <!-- Matches Grid -->
  <main class="max-w-7xl mx-auto px-6 pb-8">
    <div id="matchesContainer" class="grid gap-4">
      <div class="text-center text-gray-500 py-8">
        <div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent rounded-full mb-2"></div>
        <p>Ma√ßlar y√ºkleniyor...</p>
      </div>
    </div>
  </main>

  <!-- Edit Modal -->
  <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
      <h3 class="text-xl font-bold mb-4">üìù Logo G√ºncelle</h3>
      
      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-2">Takƒ±m Adƒ±</label>
        <input type="text" id="editTeamName" readonly class="w-full px-4 py-2 bg-gray-100 rounded-lg">
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-2">Logo URL</label>
        <input 
          type="url" 
          id="editLogoUrl" 
          placeholder="https://example.com/logo.png" 
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        >
        <p class="text-xs text-gray-500 mt-1">üí° ƒ∞pucu: Wikipedia'dan logo URL'i alabilirsiniz</p>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-700 mb-2">√ñnizleme</label>
        <div class="flex justify-center p-4 bg-gray-50 rounded-lg">
          <img id="previewImage" src="" alt="Preview" class="w-24 h-24 object-contain" style="display:none;">
          <div id="previewPlaceholder" class="w-24 h-24 bg-gray-200 rounded-lg flex items-center justify-center text-gray-400">
            üñºÔ∏è
          </div>
        </div>
      </div>

      <div class="flex gap-3">
        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
          ƒ∞ptal
        </button>
        <button onclick="saveLogoUpdate()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
          üíæ Kaydet
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDeCQtEWfOyE1hnJHb_W2ktSTqkfUjPJNc",
      authDomain: "kac-atar.firebaseapp.com",
      projectId: "kac-atar",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allMatches = [];
    let currentFilter = 'all';
    let editingMatch = null;
    let editingTeamType = null; // 'home' or 'away'

    const PLACEHOLDER = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect width='60' height='60' fill='%23fee2e2'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='32' fill='%23dc2626'%3E%3F%3C/text%3E%3C/svg%3E";

    // Load matches
    window.loadMatches = async function() {
      const container = document.getElementById('matchesContainer');
      container.innerHTML = '<div class="text-center text-gray-500 py-8"><div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent rounded-full mb-2"></div><p>Y√ºkleniyor...</p></div>';

      try {
        const querySnapshot = await getDocs(collection(db, "matches"));
        allMatches = [];
        
        querySnapshot.forEach((docSnap) => {
          const match = docSnap.data();
          match._id = docSnap.id;
          allMatches.push(match);
        });

        // Sort by date
        allMatches.sort((a, b) => {
          const dateA = new Date(a.date || a.time || 0);
          const dateB = new Date(b.date || b.time || 0);
          return dateA - dateB;
        });

        updateStats();
        renderMatches();
      } catch (error) {
        console.error("Matches load error:", error);
        container.innerHTML = '<div class="text-center text-red-500 py-8">‚ùå Y√ºkleme hatasƒ±!</div>';
      }
    };

    // Update statistics
    function updateStats() {
      const missingCount = allMatches.reduce((count, match) => {
        const homeMissing = !match.homeLogo || match.homeLogo === "";
        const awayMissing = !match.awayLogo || match.awayLogo === "";
        return count + (homeMissing ? 1 : 0) + (awayMissing ? 1 : 0);
      }, 0);

      document.getElementById('totalMatches').textContent = allMatches.length;
      document.getElementById('missingCount').textContent = missingCount;
    }

    // Render matches
    function renderMatches() {
      const container = document.getElementById('matchesContainer');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      let filtered = allMatches.filter(match => {
        const homeMissing = !match.homeLogo || match.homeLogo === "";
        const awayMissing = !match.awayLogo || match.awayLogo === "";
        const hasMissing = homeMissing || awayMissing;

        // Filter by status
        if (currentFilter === 'missing' && !hasMissing) return false;
        if (currentFilter === 'complete' && hasMissing) return false;

        // Search filter
        if (searchTerm) {
          const home = (match.home || "").toLowerCase();
          const away = (match.away || "").toLowerCase();
          return home.includes(searchTerm) || away.includes(searchTerm);
        }

        return true;
      });

      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">üòä Hi√ß ma√ß bulunamadƒ±</div>';
        return;
      }

      container.innerHTML = filtered.map(match => {
        const home = match.home || "Bilinmiyor";
        const away = match.away || "Bilinmiyor";
        const homeLogo = match.homeLogo || "";
        const awayLogo = match.awayLogo || "";
        const date = match.date ? new Date(match.date).toLocaleDateString('tr-TR') : "Tarih yok";

        const homeClass = homeLogo ? "logo-ok" : "logo-missing";
        const awayClass = awayLogo ? "logo-ok" : "logo-missing";

        return `
          <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition">
            <div class="flex items-center justify-between mb-3">
              <span class="text-xs text-gray-500 font-semibold">${date}</span>
              <span class="text-xs text-gray-400">${match.league || ""}</span>
            </div>
            
            <div class="grid grid-cols-3 gap-4 items-center">
              <!-- Home Team -->
              <div class="text-center">
                <div class="flex justify-center mb-2">
                  <img 
                    src="${homeLogo || PLACEHOLDER}" 
                    alt="${home}" 
                    class="w-16 h-16 object-contain rounded-lg ${homeClass} cursor-pointer hover:scale-110 transition"
                    onclick="openEditModal('${match._id}', 'home')"
                    onerror="this.src='${PLACEHOLDER}'"
                  >
                </div>
                <p class="font-semibold text-sm">${home}</p>
                ${!homeLogo ? '<p class="text-xs text-red-500 font-semibold">‚ùå Logo eksik</p>' : '<p class="text-xs text-green-500">‚úÖ</p>'}
              </div>

              <!-- VS -->
              <div class="text-center">
                <span class="text-2xl font-bold text-gray-400">VS</span>
              </div>

              <!-- Away Team -->
              <div class="text-center">
                <div class="flex justify-center mb-2">
                  <img 
                    src="${awayLogo || PLACEHOLDER}" 
                    alt="${away}" 
                    class="w-16 h-16 object-contain rounded-lg ${awayClass} cursor-pointer hover:scale-110 transition"
                    onclick="openEditModal('${match._id}', 'away')"
                    onerror="this.src='${PLACEHOLDER}'"
                  >
                </div>
                <p class="font-semibold text-sm">${away}</p>
                ${!awayLogo ? '<p class="text-xs text-red-500 font-semibold">‚ùå Logo eksik</p>' : '<p class="text-xs text-green-500">‚úÖ</p>'}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Filter matches
    window.filterMatches = function(filter) {
      currentFilter = filter;
      
      // Update button styles
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-blue-500', 'font-bold');
      });
      event.target.classList.add('ring-2', 'ring-blue-500', 'font-bold');
      
      renderMatches();
    };

    // Search
    document.getElementById('searchInput').addEventListener('input', renderMatches);

    // Open edit modal
    window.openEditModal = function(matchId, teamType) {
      const match = allMatches.find(m => m._id === matchId);
      if (!match) return;

      editingMatch = match;
      editingTeamType = teamType;

      const teamName = teamType === 'home' ? match.home : match.away;
      const currentLogo = teamType === 'home' ? match.homeLogo : match.awayLogo;

      document.getElementById('editTeamName').value = teamName;
      document.getElementById('editLogoUrl').value = currentLogo || "";
      
      if (currentLogo) {
        document.getElementById('previewImage').src = currentLogo;
        document.getElementById('previewImage').style.display = 'block';
        document.getElementById('previewPlaceholder').style.display = 'none';
      } else {
        document.getElementById('previewImage').style.display = 'none';
        document.getElementById('previewPlaceholder').style.display = 'flex';
      }

      document.getElementById('editModal').classList.remove('hidden');
    };

    // Close modal
    window.closeModal = function() {
      document.getElementById('editModal').classList.add('hidden');
      editingMatch = null;
      editingTeamType = null;
    };

    // Preview logo
    document.getElementById('editLogoUrl').addEventListener('input', (e) => {
      const url = e.target.value.trim();
      const preview = document.getElementById('previewImage');
      const placeholder = document.getElementById('previewPlaceholder');

      if (url) {
        preview.src = url;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
      } else {
        preview.style.display = 'none';
        placeholder.style.display = 'flex';
      }
    });

    // Save logo update
    window.saveLogoUpdate = async function() {
      if (!editingMatch || !editingTeamType) return;

      const newLogoUrl = document.getElementById('editLogoUrl').value.trim();
      const teamName = editingTeamType === 'home' ? editingMatch.home : editingMatch.away;

      if (!newLogoUrl) {
        alert('‚ö†Ô∏è L√ºtfen bir logo URL\'i girin!');
        return;
      }

      try {
        // 1. Update teams collection
        const teamRef = doc(db, "teams", teamName.toLowerCase().replace(/\s+/g, '-'));
        await setDoc(teamRef, {
          name: teamName,
          nameLower: teamName.toLowerCase().trim(),
          logo: newLogoUrl,
          lastUpdated: new Date().toISOString(),
        }, { merge: true });

        // 2. Update this match
        const matchRef = doc(db, "matches", editingMatch._id);
        const updateField = editingTeamType === 'home' ? 'homeLogo' : 'awayLogo';
        await updateDoc(matchRef, { [updateField]: newLogoUrl });

        // 3. Update all matches with this team
        const allMatchesSnapshot = await getDocs(collection(db, "matches"));
        const batch = [];
        
        for (const matchDoc of allMatchesSnapshot.docs) {
          const match = matchDoc.data();
          let needsUpdate = false;
          const updates = {};

          if ((match.home || match.homeTeam) === teamName) {
            updates.homeLogo = newLogoUrl;
            needsUpdate = true;
          }
          if ((match.away || match.awayTeam) === teamName) {
            updates.awayLogo = newLogoUrl;
            needsUpdate = true;
          }

          if (needsUpdate) {
            batch.push(updateDoc(doc(db, "matches", matchDoc.id), updates));
          }
        }

        await Promise.all(batch);

        alert(`‚úÖ ${teamName} logosu g√ºncellendi!\n${batch.length} ma√ß etkilendi.`);
        closeModal();
        await loadMatches();
      } catch (error) {
        console.error("Save error:", error);
        alert('‚ùå Kaydetme hatasƒ±: ' + error.message);
      }
    };

    // Initial load
    loadMatches();
  </script>
</body>
</html>
