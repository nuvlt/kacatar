<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ” Admin Panel - Logo YÃ¶netimi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .logo-missing { border: 3px solid #ef4444; }
    .logo-ok { border: 3px solid #10b981; }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">ğŸ”</div>
        <h1 class="text-3xl font-bold text-gray-800">Admin Panel</h1>
        <p class="text-gray-500 mt-2">Logo YÃ¶netim Sistemi</p>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">KullanÄ±cÄ± AdÄ±</label>
          <input 
            type="text" 
            id="loginUsername" 
            placeholder="admin"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            onkeypress="if(event.key==='Enter') document.getElementById('loginPassword').focus()"
          >
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Åifre</label>
          <input 
            type="password" 
            id="loginPassword" 
            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            onkeypress="if(event.key==='Enter') attemptLogin()"
          >
        </div>

        <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>

        <button 
          onclick="attemptLogin()" 
          class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition transform hover:scale-105"
        >
          ğŸš€ GiriÅŸ Yap
        </button>
      </div>

      <div class="mt-6 text-center text-xs text-gray-400">
        <p>ğŸ”’ GÃ¼venli GiriÅŸ</p>
      </div>
    </div>
  </div>

  <!-- Main Panel (Hidden by default) -->
  <div id="mainPanel" class="hidden">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold">ğŸ” Admin Panel</h1>
          <p class="text-sm text-blue-100">Logo YÃ¶netimi & GÃ¼ncelleme</p>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-right">
            <div class="text-sm">Toplam MaÃ§: <span id="totalMatches" class="font-bold">-</span></div>
            <div class="text-sm">Eksik Logo: <span id="missingCount" class="font-bold text-red-300">-</span></div>
          </div>
          <button onclick="manualSync()" id="syncBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-semibold">
            ğŸ”„ MaÃ§larÄ± GÃ¼ncelle
          </button>
          <button onclick="openSuperligModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-semibold">
            ğŸ‡¹ğŸ‡· SÃ¼per Lig Ekle
          </button>
          <button onclick="forceUpdateScores()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition font-semibold">
            ğŸ”„ SkorlarÄ± GÃ¼ncelle
          </button>
          <button onclick="openSuperligScoreModal()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition font-semibold">
            âš½ SÃ¼per Lig Skorlar
          </button>
          <button onclick="logout()" class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 transition">
            ğŸšª Ã‡Ä±kÄ±ÅŸ
          </button>
        </div>
      </div>
    </header>

    <!-- Filter Bar -->
    <div class="max-w-7xl mx-auto px-6 py-4">
      <div class="bg-white rounded-lg shadow p-4 flex gap-4 items-center">
        <div class="flex-1">
          <input 
            type="text" 
            id="searchInput" 
            placeholder="ğŸ” TakÄ±m adÄ± ara..." 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
        </div>
        <div class="flex gap-2">
          <button onclick="filterMatches('all')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 ring-2 ring-blue-500 font-bold">
            TÃ¼mÃ¼
          </button>
          <button onclick="filterMatches('missing')" class="filter-btn px-4 py-2 rounded-lg bg-red-100 text-red-700 hover:bg-red-200">
            Eksikler
          </button>
          <button onclick="filterMatches('complete')" class="filter-btn px-4 py-2 rounded-lg bg-green-100 text-green-700 hover:bg-green-200">
            Tamamlar
          </button>
        </div>
        <button onclick="loadMatches()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
          ğŸ”„ Yenile
        </button>
      </div>
    </div>

    <!-- Matches Grid -->
    <main class="max-w-7xl mx-auto px-6 pb-8">
      <div id="matchesContainer" class="grid gap-4">
        <div class="text-center text-gray-500 py-8">
          <div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent rounded-full mb-2"></div>
          <p>MaÃ§lar yÃ¼kleniyor...</p>
        </div>
      </div>
    </main>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
        <h3 class="text-xl font-bold mb-4">ğŸ“ Logo GÃ¼ncelle</h3>
        
        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-2">TakÄ±m AdÄ±</label>
          <input type="text" id="editTeamName" readonly class="w-full px-4 py-2 bg-gray-100 rounded-lg">
        </div>

        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Logo URL</label>
          <input 
            type="url" 
            id="editLogoUrl" 
            placeholder="https://example.com/logo.png" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
          <p class="text-xs text-gray-500 mt-1">ğŸ’¡ Ä°pucu: Wikipedia'dan logo URL'i alabilirsiniz</p>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-semibold text-gray-700 mb-2">Ã–nizleme</label>
          <div class="flex justify-center p-4 bg-gray-50 rounded-lg">
            <img id="previewImage" src="" alt="Preview" class="w-24 h-24 object-contain" style="display:none;">
            <div id="previewPlaceholder" class="w-24 h-24 bg-gray-200 rounded-lg flex items-center justify-center text-gray-400">
              ğŸ–¼ï¸
            </div>
          </div>
        </div>

        <div class="flex gap-3">
          <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
            Ä°ptal
          </button>
          <button onclick="saveLogoUpdate()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
            ğŸ’¾ Kaydet
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- SÃ¼per Lig Modal -->
  <div id="superligModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
      <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
        ğŸ‡¹ğŸ‡· SÃ¼per Lig MaÃ§Ä± Ekle
      </h3>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Ev Sahibi TakÄ±m</label>
          <input 
            type="text" 
            id="slHomeTeam" 
            placeholder="Galatasaray"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Deplasman TakÄ±mÄ±</label>
          <input 
            type="text" 
            id="slAwayTeam" 
            placeholder="FenerbahÃ§e"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Tarih</label>
          <input 
            type="date" 
            id="slDate" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Saat (Opsiyonel)</label>
          <input 
            type="time" 
            id="slTime" 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
          >
        </div>
      </div>

      <div class="flex gap-3 mt-6">
        <button onclick="closeSuperligModal()" class="flex-1 px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
          Ä°ptal
        </button>
        <button onclick="addSuperligMatch()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
          â• Ekle
        </button>
      </div>
    </div>
  </div>

  <!-- SÃ¼per Lig Skor GiriÅŸi Modal -->
  <div id="superligScoreModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full p-6 my-8">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold flex items-center gap-2">
          âš½ SÃ¼per Lig MaÃ§ SkorlarÄ±
        </h3>
        <button onclick="closeSuperligScoreModal()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">
          Ã—
        </button>
      </div>
      
      <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <p class="text-sm text-blue-800">
          â„¹ï¸ Sadece <strong>bekleyen</strong> SÃ¼per Lig maÃ§larÄ± gÃ¶steriliyor. Skor girdikten sonra otomatik olarak TÃœM kullanÄ±cÄ±larÄ±n tahminleri gÃ¼ncellenecek.
        </p>
      </div>

      <div id="superligMatchesList" class="space-y-4">
        <div class="text-center py-8">
          <div class="animate-spin inline-block w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full mb-2"></div>
          <p class="text-gray-500">MaÃ§lar yÃ¼kleniyor...</p>
        </div>
      </div>

      <div class="flex justify-end gap-3 mt-6 pt-6 border-t">
        <button onclick="closeSuperligScoreModal()" class="px-6 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 font-semibold">
          Kapat
        </button>
      </div>
    </div>
  </div>

  <script>
    // Global fonksiyonlar (module scope dÄ±ÅŸÄ±nda)
    window.openSuperligModal = function() {
      document.getElementById('superligModal').classList.remove('hidden');
    };

    window.closeSuperligModal = function() {
      document.getElementById('superligModal').classList.add('hidden');
      document.getElementById('slHomeTeam').value = '';
      document.getElementById('slAwayTeam').value = '';
      document.getElementById('slDate').value = '';
      document.getElementById('slTime').value = '';
    };

    window.openSuperligScoreModal = async function() {
      const modal = document.getElementById('superligScoreModal');
      modal.classList.remove('hidden');
      
      // Biraz bekle ki modal aÃ§Ä±lsÄ±n, sonra module scope fonksiyonunu Ã§aÄŸÄ±r
      setTimeout(async () => {
        if (typeof window.loadPendingSuperligMatches === 'function') {
          await window.loadPendingSuperligMatches();
        } else {
          // EÄŸer fonksiyon henÃ¼z yÃ¼klenmediyse, 1 saniye daha bekle
          setTimeout(async () => {
            if (typeof window.loadPendingSuperligMatches === 'function') {
              await window.loadPendingSuperligMatches();
            } else {
              document.getElementById('superligMatchesList').innerHTML = 
                '<div class="text-center py-8 text-red-500"><p class="text-xl">âš ï¸ Fonksiyon henÃ¼z yÃ¼klenmedi!</p><p class="text-sm mt-2">SayfayÄ± yenileyin (Ctrl+Shift+R)</p></div>';
            }
          }, 1000);
        }
      }, 100);
    };

    window.closeSuperligScoreModal = function() {
      document.getElementById('superligScoreModal').classList.add('hidden');
    };

    // ========== Bekleyen SÃ¼per Lig maÃ§larÄ±nÄ± yÃ¼kle (API'den) ==========
    async function loadPendingSuperligMatches() {
      const container = document.getElementById('superligMatchesList');
      container.innerHTML = '<div class="text-center py-8"><div class="animate-spin inline-block w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full mb-2"></div><p class="text-gray-500">MaÃ§lar yÃ¼kleniyor...</p></div>';

      try {
        // API'den Ã§ek (Firestore import sorunu yok!)
        const response = await fetch('/api/admin?action=get-pending-superlig', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            key: sessionStorage.getItem('adminKey') || 'temp' 
          })
        });

        const data = await response.json();

        if (!data.ok) {
          throw new Error(data.error || 'API hatasÄ±');
        }

        const matches = data.matches || [];

        if (matches.length === 0) {
          container.innerHTML = '<div class="text-center py-8"><div class="text-6xl mb-4">âœ…</div><p class="text-xl text-gray-700">Bekleyen SÃ¼per Lig maÃ§Ä± yok!</p><p class="text-sm text-gray-500 mt-2">TÃ¼m maÃ§lar skorlandÄ±.</p></div>';
          return;
        }

        container.innerHTML = matches.map((match, index) => `
          <div class="border border-gray-200 rounded-lg p-4 hover:border-orange-300 transition">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-4 flex-1">
                <div class="text-center flex-1">
                  ${match.homeLogo ? `<img src="${match.homeLogo}" class="w-12 h-12 mx-auto mb-2 object-contain" onerror="this.style.display='none'">` : ''}
                  <p class="font-bold text-sm">${match.home}</p>
                </div>
                
                <div class="text-center px-4">
                  <p class="text-2xl font-bold text-gray-400">VS</p>
                </div>
                
                <div class="text-center flex-1">
                  ${match.awayLogo ? `<img src="${match.awayLogo}" class="w-12 h-12 mx-auto mb-2 object-contain" onerror="this.style.display='none'">` : ''}
                  <p class="font-bold text-sm">${match.away}</p>
                </div>
              </div>

              <div class="ml-4 text-right">
                <p class="text-xs text-gray-500">${new Date(match.date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' })}</p>
                <p class="text-xs text-orange-600 font-semibold">${match.count} tahmin</p>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <div class="flex-1 flex items-center gap-2">
                <input 
                  type="number" 
                  min="0" 
                  max="10" 
                  placeholder="0"
                  id="homeScore_${index}"
                  class="w-16 h-12 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                >
                <span class="text-2xl font-bold text-gray-400">-</span>
                <input 
                  type="number" 
                  min="0" 
                  max="10" 
                  placeholder="0"
                  id="awayScore_${index}"
                  class="w-16 h-12 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                >
              </div>
              
              <button 
                onclick="submitSingleMatchScore('${match.matchId}', ${index})"
                class="px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-semibold transition transform hover:scale-105"
              >
                ğŸ’¾ Kaydet
              </button>
            </div>

            <div class="mt-2 text-xs text-gray-400 font-mono">
              ID: ${match.matchId}
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Load matches error:', error);
        container.innerHTML = '<div class="text-center py-8 text-red-500"><div class="text-6xl mb-4">âŒ</div><p class="text-xl">YÃ¼kleme hatasÄ±!</p><p class="text-sm mt-2">' + error.message + '</p></div>';
      }
    }

    // Global'e export et
    window.loadPendingSuperligMatches = loadPendingSuperligMatches;

    // ========== Tek bir maÃ§Ä±n skorunu kaydet ==========
    async function submitSingleMatchScore(matchId, index) {
      const homeScore = document.getElementById(`homeScore_${index}`).value;
      const awayScore = document.getElementById(`awayScore_${index}`).value;

      if (!homeScore || !awayScore) {
        alert('âš ï¸ LÃ¼tfen her iki skoru da girin!');
        return;
      }

      const actualScore = `${homeScore}-${awayScore}`;

      if (!confirm(`ğŸ¯ Skor: ${actualScore}\n\nTÃœM kullanÄ±cÄ±larÄ±n tahminleri gÃ¼ncellenecek. Emin misiniz?`)) {
        return;
      }

      try {
        let SECRET_KEY = sessionStorage.getItem('adminKey');
        
        if (!SECRET_KEY) {
          SECRET_KEY = prompt('ğŸ”‘ Secret Key:');
          if (!SECRET_KEY) return;
          sessionStorage.setItem('adminKey', SECRET_KEY);
        }

        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'â³ Kaydediliyor...';
        button.classList.add('opacity-50');

        const response = await fetch('/api/admin?action=manual-superlig-scores', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            key: SECRET_KEY, 
            matchId: matchId,
            actualScore: actualScore
          })
        });

        const result = await response.json();

        if (result.ok) {
          button.textContent = 'âœ… Kaydedildi';
          button.classList.remove('bg-orange-500', 'hover:bg-orange-600');
          button.classList.add('bg-green-500');
          
          setTimeout(async () => {
            await loadPendingSuperligMatches();
          }, 1500);
        } else {
          if (response.status === 403) {
            sessionStorage.removeItem('adminKey');
            alert('âŒ GeÃ§ersiz secret key! Tekrar deneyin.');
          } else {
            alert(`âŒ Hata: ${result.error}`);
          }
          button.disabled = false;
          button.textContent = originalText;
          button.classList.remove('opacity-50');
        }
      } catch (error) {
        console.error('Submit score error:', error);
        alert('âŒ BaÄŸlantÄ± hatasÄ±: ' + error.message);
        const button = event.target;
        button.disabled = false;
        button.textContent = 'ğŸ’¾ Kaydet';
        button.classList.remove('opacity-50');
      }
    }

    // Global'e export et
    window.submitSingleMatchScore = submitSingleMatchScore;

    window.submitSuperligScore = async function() {
      // Deprecated - artÄ±k kullanÄ±lmÄ±yor
      alert('Bu fonksiyon artÄ±k kullanÄ±lmÄ±yor. MaÃ§lar listeden skorlanÄ±yor.');
    };

    // Force Update Scores (GLOBAL SCOPE)
    window.forceUpdateScores = async function() {
      if (!confirm('ğŸ”„ Bekleyen maÃ§larÄ±n skorlarÄ±nÄ± API\'den Ã§ekmek istiyor musunuz?\n\nBu iÅŸlem 1-2 dakika sÃ¼rebilir.')) {
        return;
      }

      try {
        const SECRET_KEY = prompt('ğŸ”‘ Secret Key:');
        if (!SECRET_KEY) return;

        const statusDiv = document.createElement('div');
        statusDiv.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-4 rounded-lg shadow-lg z-50';
        statusDiv.innerHTML = 'â³ Skorlar gÃ¼ncelleniyor...';
        document.body.appendChild(statusDiv);

        const response = await fetch('/api/admin?action=force-update-scores', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key: SECRET_KEY })
        });

        const result = await response.json();

        statusDiv.remove();

        if (result.ok) {
          alert(`âœ… ${result.message}\n\nDetay:\n- Bekleyen: ${result.stats?.totalPending || 0}\n- Skor Bulundu: ${result.stats?.scoresFound || 0}\n- GÃ¼ncellenen: ${result.stats?.updated || 0}`);
        } else {
          alert(`âŒ Hata: ${result.error}`);
        }
      } catch (error) {
        console.error('Force update error:', error);
        alert('âŒ BaÄŸlantÄ± hatasÄ±!');
      }
    };
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDeCQtEWfOyE1hnJHb_W2ktSTqkfUjPJNc",
      authDomain: "kac-atar.firebaseapp.com",
      projectId: "kac-atar",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allMatches = [];
    let currentFilter = 'all';
    let editingMatch = null;
    let editingTeamType = null;

    const PLACEHOLDER = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect width='60' height='60' fill='%23fee2e2'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='32' fill='%23dc2626'%3E%3F%3C/text%3E%3C/svg%3E";

    // ========== YENÄ° API ENDPOINT: /api/admin ==========
    
    // Login attempt
    window.attemptLogin = async function() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorDiv = document.getElementById('loginError');

      try {
        const response = await fetch('/api/admin?action=check-auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const result = await response.json();

        if (result.ok) {
          sessionStorage.setItem('adminLoggedIn', 'true');
          document.getElementById('loginScreen').classList.add('hidden');
          document.getElementById('mainPanel').classList.remove('hidden');
          loadMatches();
        } else {
          errorDiv.textContent = 'âŒ ' + (result.message || 'GiriÅŸ baÅŸarÄ±sÄ±z!');
          errorDiv.classList.remove('hidden');
          document.getElementById('loginPassword').value = '';
          document.getElementById('loginPassword').focus();
        }
      } catch (error) {
        console.error('Login error:', error);
        errorDiv.textContent = 'âŒ BaÄŸlantÄ± hatasÄ±!';
        errorDiv.classList.remove('hidden');
      }
    };

    // Logout
    window.logout = function() {
      if (confirm('ğŸšª Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?')) {
        sessionStorage.removeItem('adminLoggedIn');
        document.getElementById('mainPanel').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
      }
    };

    // Manual Sync
    window.manualSync = async function() {
      const btn = document.getElementById('syncBtn');
      const originalText = btn.textContent;
      
      btn.disabled = true;
      btn.textContent = 'â³ GÃ¼ncelleniyor...';
      btn.classList.add('opacity-50', 'cursor-not-allowed');
      
      try {
        const SECRET_KEY = prompt('ğŸ”‘ Secret Key girin:');
        
        if (!SECRET_KEY) {
          alert('âŒ Secret key gerekli!');
          return;
        }
        
        const response = await fetch(`/api/sync-matches?key=${SECRET_KEY}`);
        const result = await response.json();
        
        if (result.ok) {
          alert(`âœ… BaÅŸarÄ±lÄ±!\n\n${result.message}\n\nToplam: ${result.stats.totalMatches} maÃ§`);
          await loadMatches();
        } else {
          alert('âŒ Hata: ' + (result.error || 'Bilinmeyen hata'));
        }
      } catch (error) {
        console.error('Sync error:', error);
        alert('âŒ BaÄŸlantÄ± hatasÄ±!');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    };

    // SÃ¼per Lig - Add match function (YENÄ° API)
    window.addSuperligMatch = async function() {
      const home = document.getElementById('slHomeTeam').value.trim();
      const away = document.getElementById('slAwayTeam').value.trim();
      const date = document.getElementById('slDate').value;
      const time = document.getElementById('slTime').value;

      if (!home || !away || !date) {
        alert('âš ï¸ LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun!');
        return;
      }

      try {
        const SECRET_KEY = prompt('ğŸ”‘ Secret Key:');
        if (!SECRET_KEY) return;

        const response = await fetch('/api/admin?action=add-superlig-match', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key: SECRET_KEY, home, away, date, time })
        });

        const result = await response.json();

        if (result.ok) {
          alert(`âœ… ${result.message}`);
          window.closeSuperligModal();
          await loadMatches();
        } else {
          alert(`âŒ Hata: ${result.error}`);
        }
      } catch (error) {
        console.error('Add match error:', error);
        alert('âŒ BaÄŸlantÄ± hatasÄ±!');
      }
    };

    // Check if already logged in
    if (sessionStorage.getItem('adminLoggedIn') === 'true') {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainPanel').classList.remove('hidden');
    }

    // Load matches
    window.loadMatches = async function() {
      const container = document.getElementById('matchesContainer');
      container.innerHTML = '<div class="text-center text-gray-500 py-8"><div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent rounded-full mb-2"></div><p>YÃ¼kleniyor...</p></div>';

      try {
        const querySnapshot = await getDocs(collection(db, "matches"));
        allMatches = [];
        
        querySnapshot.forEach((docSnap) => {
          const match = docSnap.data();
          match._id = docSnap.id;
          allMatches.push(match);
        });

        allMatches.sort((a, b) => {
          const dateA = new Date(a.date || a.time || 0);
          const dateB = new Date(b.date || b.time || 0);
          return dateA - dateB;
        });

        updateStats();
        renderMatches();
      } catch (error) {
        console.error("Matches load error:", error);
        container.innerHTML = '<div class="text-center text-red-500 py-8">âŒ YÃ¼kleme hatasÄ±!</div>';
      }
    };

    function updateStats() {
      const missingCount = allMatches.reduce((count, match) => {
        const homeMissing = !match.homeLogo || match.homeLogo === "";
        const awayMissing = !match.awayLogo || match.awayLogo === "";
        return count + (homeMissing ? 1 : 0) + (awayMissing ? 1 : 0);
      }, 0);

      document.getElementById('totalMatches').textContent = allMatches.length;
      document.getElementById('missingCount').textContent = missingCount;
    }

    function renderMatches() {
      const container = document.getElementById('matchesContainer');
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      let filtered = allMatches.filter(match => {
        const homeMissing = !match.homeLogo || match.homeLogo === "";
        const awayMissing = !match.awayLogo || match.awayLogo === "";
        const hasMissing = homeMissing || awayMissing;

        if (currentFilter === 'missing' && !hasMissing) return false;
        if (currentFilter === 'complete' && hasMissing) return false;

        if (searchTerm) {
          const home = (match.home || "").toLowerCase();
          const away = (match.away || "").toLowerCase();
          return home.includes(searchTerm) || away.includes(searchTerm);
        }

        return true;
      });

      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">ğŸ˜Š HiÃ§ maÃ§ bulunamadÄ±</div>';
        return;
      }

      container.innerHTML = filtered.map(match => {
        const home = match.home || "Bilinmiyor";
        const away = match.away || "Bilinmiyor";
        const homeLogo = match.homeLogo || "";
        const awayLogo = match.awayLogo || "";
        const date = match.date ? new Date(match.date).toLocaleDateString('tr-TR') : "Tarih yok";

        const homeClass = homeLogo ? "logo-ok" : "logo-missing";
        const awayClass = awayLogo ? "logo-ok" : "logo-missing";

        return `
          <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition">
            <div class="flex items-center justify-between mb-3">
              <span class="text-xs text-gray-500 font-semibold">${date}</span>
              <span class="text-xs text-gray-400">${match.league || ""}</span>
            </div>
            
            <div class="grid grid-cols-3 gap-4 items-center">
              <div class="text-center">
                <div class="flex justify-center mb-2">
                  <img 
                    src="${homeLogo || PLACEHOLDER}" 
                    alt="${home}" 
                    class="w-16 h-16 object-contain rounded-lg ${homeClass} cursor-pointer hover:scale-110 transition"
                    onclick="openEditModal('${match._id}', 'home')"
                    onerror="this.src='${PLACEHOLDER}'"
                  >
                </div>
                <p class="font-semibold text-sm">${home}</p>
                ${!homeLogo ? '<p class="text-xs text-red-500 font-semibold">âŒ Logo eksik</p>' : '<p class="text-xs text-green-500">âœ…</p>'}
              </div>

              <div class="text-center">
                <span class="text-2xl font-bold text-gray-400">VS</span>
              </div>

              <div class="text-center">
                <div class="flex justify-center mb-2">
                  <img 
                    src="${awayLogo || PLACEHOLDER}" 
                    alt="${away}" 
                    class="w-16 h-16 object-contain rounded-lg ${awayClass} cursor-pointer hover:scale-110 transition"
                    onclick="openEditModal('${match._id}', 'away')"
                    onerror="this.src='${PLACEHOLDER}'"
                  >
                </div>
                <p class="font-semibold text-sm">${away}</p>
                ${!awayLogo ? '<p class="text-xs text-red-500 font-semibold">âŒ Logo eksik</p>' : '<p class="text-xs text-green-500">âœ…</p>'}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    window.filterMatches = function(filter) {
      currentFilter = filter;
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-blue-500', 'font-bold');
      });
      event.target.classList.add('ring-2', 'ring-blue-500', 'font-bold');
      
      renderMatches();
    };

    document.getElementById('searchInput').addEventListener('input', renderMatches);

    window.openEditModal = function(matchId, teamType) {
      const match = allMatches.find(m => m._id === matchId);
      if (!match) return;

      editingMatch = match;
      editingTeamType = teamType;

      const teamName = teamType === 'home' ? match.home : match.away;
      const currentLogo = teamType === 'home' ? match.homeLogo : match.awayLogo;

      document.getElementById('editTeamName').value = teamName;
      document.getElementById('editLogoUrl').value = currentLogo || "";
      
      if (currentLogo) {
        document.getElementById('previewImage').src = currentLogo;
        document.getElementById('previewImage').style.display = 'block';
        document.getElementById('previewPlaceholder').style.display = 'none';
      } else {
        document.getElementById('previewImage').style.display = 'none';
        document.getElementById('previewPlaceholder').style.display = 'flex';
      }

      document.getElementById('editModal').classList.remove('hidden');
    };

    window.closeModal = function() {
      document.getElementById('editModal').classList.add('hidden');
      editingMatch = null;
      editingTeamType = null;
    };

    document.getElementById('editLogoUrl').addEventListener('input', (e) => {
      const url = e.target.value.trim();
      const preview = document.getElementById('previewImage');
      const placeholder = document.getElementById('previewPlaceholder');

      if (url) {
        preview.src = url;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
      } else {
        preview.style.display = 'none';
        placeholder.style.display = 'flex';
      }
    });

    // ========== YENÄ°: Logo Update API ==========
    window.saveLogoUpdate = async function() {
      if (!editingMatch || !editingTeamType) return;

      const newLogoUrl = document.getElementById('editLogoUrl').value.trim();
      const teamName = editingTeamType === 'home' ? editingMatch.home : editingMatch.away;

      if (!newLogoUrl) {
        alert('âš ï¸ LÃ¼tfen bir logo URL\'i girin!');
        return;
      }

      if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
        alert('âŒ LÃ¼tfen Ã¶nce admin giriÅŸi yapÄ±n!');
        return;
      }

      try {
        let adminKey = sessionStorage.getItem('adminKey');
        
        if (!adminKey) {
          adminKey = prompt('ğŸ”‘ Admin Key:');
          if (!adminKey) {
            alert('âŒ Admin key gerekli!');
            return;
          }
          sessionStorage.setItem('adminKey', adminKey);
        }

        const response = await fetch('/api/admin?action=update-logo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            teamName: teamName,
            logoUrl: newLogoUrl,
            adminKey: adminKey
          })
        });

        const result = await response.json();

        if (response.ok && result.ok) {
          alert(`âœ… ${result.message}\n${result.updatedMatches} maÃ§ gÃ¼ncellendi.`);
          closeModal();
          await loadMatches();
        } else {
          if (response.status === 403) {
            sessionStorage.removeItem('adminKey');
            alert('âŒ GeÃ§ersiz admin key! Tekrar deneyin.');
          } else {
            alert(`âŒ Hata: ${result.error}`);
          }
        }
      } catch (error) {
        console.error("Save error:", error);
        alert('âŒ Kaydetme hatasÄ±: ' + error.message);
      }
    };
  </script>
</body>
</html>
