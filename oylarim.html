// oylarim.html - loadMyVotes fonksiyonunu bu ile deÄŸiÅŸtir

async function loadMyVotes() {
  const container = document.getElementById('votesContainer');

  if (!currentUser) {
    container.innerHTML = '<div class="col-span-full text-center py-16"><div class="text-6xl mb-4">ğŸ”</div><p class="text-xl text-gray-700 mb-4">GiriÅŸ yapÄ±lÄ±yor...</p></div>';
    return;
  }

  try {
    console.log('ğŸ”„ Loading user votes for:', currentUser.uid);
    
    const matchesSnapshot = await getDocs(collection(db, "matches"));
    allVotes = [];
    
    // Ã–nce kullanÄ±cÄ±nÄ±n oy verdiÄŸi maÃ§larÄ± bul
    const userVotedMatches = [];
    matchesSnapshot.forEach(docSnap => {
      const match = docSnap.data();
      const userVote = match.votes?.[currentUser.uid];
      
      if (userVote) {
        userVotedMatches.push({
          id: docSnap.id,
          home: match.home,
          away: match.away,
          homeLogo: match.homeLogo,
          awayLogo: match.awayLogo,
          league: match.league,
          date: match.date,
          myVote: userVote
        });
      }
    });

    console.log(`ğŸ“Š ${userVotedMatches.length} oy verilmiÅŸ maÃ§ bulundu`);

    if (userVotedMatches.length === 0) {
      allVotes = [];
      updateStats();
      renderVotes();
      return;
    }

    // SonuÃ§larÄ± al (tÃ¼m ligler yerine sadece week)
    let liveScores = {};
    try {
      console.log('ğŸ”„ Skorlar getiriliyor...');
      const scoresResponse = await fetch('/api/live-scores?filter=week');
      
      if (scoresResponse.ok) {
        const scoresData = await scoresResponse.json();
        scoresData.matches?.forEach(m => {
          liveScores[String(m.id)] = {
            homeScore: m.homeScore,
            awayScore: m.awayScore,
            status: m.status
          };
        });
        console.log(`âœ… ${Object.keys(liveScores).length} skor bulundu`);
      }
    } catch (e) {
      console.warn('âš ï¸ Skorlar alÄ±namadÄ±:', e);
    }

    // SkorlarÄ± eÅŸleÅŸtir
    allVotes = userVotedMatches.map(match => {
      const score = liveScores[match.id];
      let status = 'pending';
      let actualScore = null;

      if (score && score.status === 'FINISHED') {
        actualScore = `${score.homeScore}-${score.awayScore}`;
        status = match.myVote === actualScore ? 'correct' : 'wrong';
      }

      return {
        ...match,
        actualScore,
        status
      };
    });

    // Tarihe gÃ¶re sÄ±rala (yeniden eskiye)
    allVotes.sort((a, b) => {
      const dateA = new Date(a.date || 0);
      const dateB = new Date(b.date || 0);
      return dateB - dateA;
    });

    console.log(`âœ… Tahminler hazÄ±r (${allVotes.length} adet)`);

    updateStats();
    renderVotes();

  } catch (error) {
    console.error('âŒ Load votes error:', error);
    container.innerHTML = `
      <div class="col-span-full text-center text-red-500 py-8">
        <div class="text-6xl mb-4">âŒ</div>
        <p class="text-xl mb-2">Tahminler yÃ¼klenemedi</p>
        <p class="text-sm text-gray-500">${error.message}</p>
        <a href="/" class="mt-4 inline-block px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          Ana Sayfaya DÃ¶n
        </a>
      </div>
    `;
  }
}
