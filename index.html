<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kaç Atar</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- Header -->
  <header class="bg-white shadow sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 flex items-center justify-between h-16">
      <h1 class="text-xl font-bold text-blue-600">Kaç Atar</h1>
      <nav class="flex gap-6 text-gray-600">
        <a href="#" class="hover:text-blue-600">Maçlar</a>
        <a href="#" class="hover:text-blue-600">Tahminler</a>
        <a href="#" class="hover:text-blue-600">Sonuçlar</a>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-3xl mx-auto px-4 py-8">
    <h2 class="text-3xl font-bold text-center mb-8">Yaklaşan Maçlar</h2>
    <div id="matches" class="space-y-6"></div>
  </main>

  <!-- Firebase + JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // --- FIREBASE CONFIG (kendi değerlerinle bırak) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDeCQtEWfOyE1hnJHb_W2ktSTqkfUjPJNc",
      authDomain: "kac-atar.firebaseapp.com",
      projectId: "kac-atar",
      storageBucket: "kac-atar.firebasestorage.app",
      messagingSenderId: "1070494452209",
      appId: "1:1070494452209:web:e24a9bbd0b4fb543a79c50",
      measurementId: "G-8ZMRLXBX7Z"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let currentUser = null;

    // Anon giriş
    signInAnonymously(auth).catch((err) => console.error("Auth error:", err));
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        console.log("Anon user signed in:", user.uid);
      }
    });

    // 1x1 şeffaf GIF (logo yoksa kırık resim çıkmasın)
    const TRANSPARENT_PX = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";

    // --- Tarih parse & format yardımcıları ---
    function parseDateField(dateField, timeField) {
      if (!dateField) return null;

      if (typeof dateField === "object") {
        if (typeof dateField.seconds === "number") return new Date(dateField.seconds * 1000);
        if (typeof dateField.toDate === "function") {
          try { return dateField.toDate(); } catch {}
        }
      }

      if (typeof dateField === "string") {
        let s = dateField;
        if (/^\d{4}-\d{2}-\d{2}$/.test(s) && timeField) s = `${s}T${timeField}`;
        const d = new Date(s);
        if (!isNaN(d)) return d;
      }

      return null;
    }

    function formatMatchDate(match) {
      const d = parseDateField(match.date, match.time);
      if (d) return d.toLocaleString("tr-TR", { dateStyle: "medium", timeStyle: "short" });
      if (match.time && !match.date) return `Saat: ${match.time}`;
      return "Tarih bilinmiyor";
    }

    // Basit HTML kaçış (gösterim için)
    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // --- Maçları yükle ve render et ---
    async function loadMatches() {
      const matchesDiv = document.getElementById("matches");
      matchesDiv.innerHTML = "";

      const snap = await getDocs(collection(db, "matches"));
      const matches = [];
      snap.forEach(s => {
        const m = s.data() || {};
        m._id = s.id;
        matches.push(m);
      });

      // Tarihe göre sırala (varsa)
      matches.sort((a, b) => {
        const da = parseDateField(a.date, a.time);
        const dbx = parseDateField(b.date, b.time);
        if (da && dbx) return da - dbx;
        if (da) return -1;
        if (dbx) return 1;
        return (a.home || "").localeCompare(b.home || "");
      });

      for (const match of matches) {
        const matchId = match._id;
        const dateText = formatMatchDate(match);
        const homeName = match.home || "Bilinmiyor";
        const awayName = match.away || "Bilinmiyor";
        const popularText = match.popularPrediction || "—";
        const voteCount = match.voteCount || 0;

        // logo alanları (boşsa transparent)
        const homeLogo = match.homeLogo || TRANSPARENT_PX;
        const awayLogo = match.awayLogo || TRANSPARENT_PX;
        const leagueName = match.league || "";

        const card = document.createElement("div");
        card.className = "match-card bg-white p-6 rounded-xl shadow flex flex-col gap-4";
        card.dataset.id = matchId;

        // DOM ile güvenli oluşturma (innerHTML ile doğrudan URL/isim eklemekten kaçınıyoruz)
        const topDiv = document.createElement("div");
        const leagueP = document.createElement("p");
        leagueP.className = "text-xs text-blue-600 font-semibold mb-1";
        leagueP.textContent = leagueName;
        const dateP = document.createElement("p");
        dateP.className = "text-sm text-gray-500 mb-1";
        dateP.textContent = dateText;

        const teamsRow = document.createElement("div");
        teamsRow.className = "flex items-center justify-between";

        const left = document.createElement("div");
        left.className = "flex items-center gap-2";
        const homeImg = document.createElement("img");
        homeImg.src = homeLogo;
        homeImg.alt = homeName;
        homeImg.className = "w-6 h-6 rounded-full border";
        const homeSpan = document.createElement("span");
        homeSpan.className = "font-semibold";
        homeSpan.textContent = homeName;
        left.appendChild(homeImg);
        left.appendChild(homeSpan);

        const vsSpan = document.createElement("span");
        vsSpan.className = "text-gray-400 font-bold";
        vsSpan.textContent = "vs";

        const right = document.createElement("div");
        right.className = "flex items-center gap-2";
        const awaySpan = document.createElement("span");
        awaySpan.className = "font-semibold";
        awaySpan.textContent = awayName;
        const awayImg = document.createElement("img");
        awayImg.src = awayLogo;
        awayImg.alt = awayName;
        awayImg.className = "w-6 h-6 rounded-full border";
        right.appendChild(awaySpan);
        right.appendChild(awayImg);

        teamsRow.appendChild(left);
        teamsRow.appendChild(vsSpan);
        teamsRow.appendChild(right);

        topDiv.appendChild(leagueP);
        topDiv.appendChild(dateP);
        topDiv.appendChild(teamsRow);

        // Oy verme satırı (ORTALANMIŞ)
        const voteRow = document.createElement("div");
        voteRow.className = "flex items-center justify-center gap-3 mt-2";

        const homeInput = document.createElement("input");
        homeInput.type = "number";
        homeInput.placeholder = homeName;
        homeInput.className = "home-score w-20 p-2 border rounded text-center";

        const dash = document.createElement("span");
        dash.className = "font-bold";
        dash.textContent = "-";

        const awayInput = document.createElement("input");
        awayInput.type = "number";
        awayInput.placeholder = awayName;
        awayInput.className = "away-score w-20 p-2 border rounded text-center";

        const voteBtn = document.createElement("button");
        voteBtn.className = "vote-button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600";
        voteBtn.textContent = "Oy Ver";

        voteRow.appendChild(homeInput);
        voteRow.appendChild(dash);
        voteRow.appendChild(awayInput);
        voteRow.appendChild(voteBtn);

        // Popüler tahmin (ortalı)
        const popularP = document.createElement("p");
        popularP.className = "text-sm text-gray-500 text-center";
        popularP.textContent = `En Popüler Tahmin: ${popularText} (${voteCount} oy)`;

        // Hepsini karta ekle
        card.appendChild(topDiv);
        card.appendChild(voteRow);
        card.appendChild(popularP);

        matchesDiv.appendChild(card);
      }
    }

    // İlk yükleme
    loadMatches();

    // Oy verme işlemi (event delegation)
    document.addEventListener("click", async (e) => {
      const btn = e.target.closest(".vote-button");
      if (!btn) return;

      // Bulunan card içinde inputları al
      const card = btn.closest(".match-card");
      const matchId = card.dataset.id;
      const homeScore = card.querySelector(".home-score").value;
      const awayScore = card.querySelector(".away-score").value;

      if (!homeScore || !awayScore) {
        alert("Lütfen skor giriniz");
        return;
      }

      if (!currentUser) {
        alert("Kullanıcı girişi bekleniyor. Birkaç saniye bekleyip tekrar deneyin.");
        return;
      }

      const prediction = `${homeScore}-${awayScore}`;

      try {
        const matchRef = doc(db, "matches", matchId);
        const matchSnap = await getDoc(matchRef);

        if (matchSnap.exists()) {
          // Kullanıcının oyunu kaydet
          await updateDoc(matchRef, { [`votes.${currentUser.uid}`]: prediction });

          // Popüler tahmini hesapla
          const updatedSnap = await getDoc(matchRef);
          const votes = updatedSnap.data().votes || {};
          const counts = {};
          Object.values(votes).forEach(p => { counts[p] = (counts[p] || 0) + 1; });

          let popular = null;
          let maxCount = 0;
          for (const [score, count] of Object.entries(counts)) {
            if (count > maxCount) { popular = score; maxCount = count; }
          }

          await updateDoc(matchRef, { popularPrediction: popular, voteCount: maxCount });

          alert("Oyun kaydedildi ✅");
          loadMatches(); // ekranı yenile
        } else {
          alert("Maç bulunamadı!");
        }
      } catch (err) {
        console.error("Oy kaydetme hatası:", err);
        alert("Oy kaydedilemedi ❌");
      }
    });
  </script>
</body>
</html>
