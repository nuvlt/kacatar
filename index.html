<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ka√ß Atar</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- Header -->
  <header class="bg-white shadow sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 flex items-center justify-between h-16">
      <h1 class="text-xl font-bold text-blue-600">Ka√ß Atar</h1>
      <nav class="flex gap-6 text-gray-600">
        <a href="#" class="hover:text-blue-600">Ma√ßlar</a>
        <a href="#" class="hover:text-blue-600">Tahminler</a>
        <a href="#" class="hover:text-blue-600">Sonu√ßlar</a>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-3xl mx-auto px-4 py-8">
    <h2 class="text-3xl font-bold text-center mb-8">Yakla≈üan Ma√ßlar</h2>
    <div id="matches" class="space-y-6"></div>
  </main>

  <!-- Firebase + JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDeCQtEWfOyE1hnJHb_W2ktSTqkfUjPJNc",
      authDomain: "kac-atar.firebaseapp.com",
      projectId: "kac-atar",
      storageBucket: "kac-atar.firebasestorage.app",
      messagingSenderId: "1070494452209",
      appId: "1:1070494452209:web:e24a9bbd0b4fb543a79c50",
      measurementId: "G-8ZMRLXBX7Z"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let currentUser = null;

    // üîπ Anon login
    signInAnonymously(auth).catch((error) => console.error("Auth error:", error));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        console.log("Anon user signed in:", user.uid);
      }
    });

    // --- Yardƒ±mcƒ±: tarih parse & format ---
    function parseDateField(dateField, timeField) {
      if (!dateField) return null;

      if (typeof dateField === "object") {
        if (typeof dateField.seconds === "number") return new Date(dateField.seconds * 1000);
        if (typeof dateField.toDate === "function") {
          try { return dateField.toDate(); } catch {}
        }
      }

      if (typeof dateField === "string") {
        let s = dateField;
        if (/^\d{4}-\d{2}-\d{2}$/.test(s) && timeField) s = `${s}T${timeField}`;
        const d = new Date(s);
        if (!isNaN(d)) return d;
      }

      return null;
    }

    function formatMatchDate(match) {
      const d = parseDateField(match.date, match.time);
      if (d) return d.toLocaleString("tr-TR", { dateStyle: "medium", timeStyle: "short" });
      if (match.time && !match.date) return `Saat: ${match.time}`;
      return "Tarih bilinmiyor";
    }

    // --- HTML g√ºvenliƒüi ---
    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // --- Ma√ßlarƒ± y√ºkle ve g√∂ster ---
    async function loadMatches() {
      const matchesDiv = document.getElementById("matches");
      matchesDiv.innerHTML = "";

      const querySnapshot = await getDocs(collection(db, "matches"));
      const matches = [];
      querySnapshot.forEach((docSnap) => {
        const m = docSnap.data() || {};
        m._id = docSnap.id;
        matches.push(m);
      });

      // Tarihe g√∂re sƒ±rala
      matches.sort((a, b) => {
        const da = parseDateField(a.date, a.time);
        const dbx = parseDateField(b.date, b.time);
        if (da && dbx) return da - dbx;
        if (da) return -1;
        if (dbx) return 1;
        return (a.home || "").localeCompare(b.home || "");
      });

      for (const match of matches) {
        const matchId = match._id;
        const dateText = formatMatchDate(match);
        const homeName = match.home || "Bilinmiyor";
        const awayName = match.away || "Bilinmiyor";
        const popularText = match.popularPrediction || "‚Äî";
        const voteCount = match.voteCount || 0;

        const homeLogo = match.homeLogo || "";
        const awayLogo = match.awayLogo || "";
        const leagueName = match.league || "";

        const card = document.createElement("div");
        card.className = "match-card bg-white p-6 rounded-xl shadow flex flex-col gap-4";
        card.dataset.id = matchId;

        card.innerHTML = `
          <div>
            <p class="text-xs text-blue-600 font-semibold mb-1">${escapeHtml(leagueName)}</p>
            <p class="text-sm text-gray-500 mb-1">${escapeHtml(dateText)}</p>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <img src="${homeLogo}" alt="${homeName}" class="w-6 h-6 rounded-full border">
                <span class="font-semibold">${escapeHtml(homeName)}</span>
              </div>
              <span class="text-gray-400 font-bold">vs</span>
              <div class="flex items-center gap-2">
                <span class="font-semibold">${escapeHtml(awayName)}</span>
                <img src="${awayLogo}" alt="${awayName}" class="w-6 h-6 rounded-full border">
              </div>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <input type="number" placeholder="${escapeHtml(homeName)}" class="home-score w-20 p-2 border rounded">
            <span class="font-bold">-</span>
            <input type="number" placeholder="${escapeHtml(awayName)}" class="away-score w-20 p-2 border rounded">
            <button class="vote-button bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Oy Ver</button>
          </div>

          <p class="text-sm text-gray-500">
            En Pop√ºler Tahmin: ${escapeHtml(popularText)} (${voteCount} oy)
          </p>
        `;

        matchesDiv.appendChild(card);
      }
    }

    // ƒ∞lk y√ºkleme
    loadMatches();

    // --- Oy verme i≈ülemi ---
    document.addEventListener("click", async (e) => {
      if (e.target.closest(".vote-button")) {
        const card = e.target.closest(".match-card");
        const matchId = card.dataset.id;
        const homeScore = card.querySelector(".home-score").value;
        const awayScore = card.querySelector(".away-score").value;

        if (!homeScore || !awayScore) {
          alert("L√ºtfen skor giriniz");
          return;
        }

        const prediction = `${homeScore}-${awayScore}`;

        try {
          const matchRef = doc(db, "matches", matchId);
          const matchSnap = await getDoc(matchRef);

          if (matchSnap.exists()) {
            await updateDoc(matchRef, { [`votes.${currentUser.uid}`]: prediction });

            const updatedSnap = await getDoc(matchRef);
            const votes = updatedSnap.data().votes || {};
            const counts = {};

            Object.values(votes).forEach((pred) => {
              counts[pred] = (counts[pred] || 0) + 1;
            });

            let popular = null;
            let maxCount = 0;
            for (let [score, count] of Object.entries(counts)) {
              if (count > maxCount) {
                popular = score;
                maxCount = count;
              }
            }

            await updateDoc(matchRef, { popularPrediction: popular, voteCount: maxCount });
            alert("Oyun kaydedildi ‚úÖ");
            loadMatches();
          } else {
            alert("Ma√ß bulunamadƒ±!");
          }
        } catch (err) {
          console.error("Oy kaydetme hatasƒ±:", err);
          alert("Oy kaydedilemedi ‚ùå");
        }
      }
    });
  </script>
</body>
</html>
